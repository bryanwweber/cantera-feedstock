From b3a6c6b77a5988c9238b500a8feeaa415df68774 Mon Sep 17 00:00:00 2001
From: Ray Speth <speth@mit.edu>
Date: Tue, 15 Aug 2023 18:44:27 -0400
Subject: [PATCH] Enable cross-compiling for v3.0.0

Cross compiling support is only available without TryRun
---
 SConstruct | 92 +-----------------------------------------------------
 1 file changed, 1 insertion(+), 91 deletions(-)

diff --git a/SConstruct b/SConstruct
index 6c813b76f..7588630f3 100644
--- a/SConstruct
+++ b/SConstruct
@@ -1163,24 +1163,6 @@ def get_expression_value(includes, expression, defines=()):
               '}\n'))
     return '\n'.join(s)
 
-# Check that libraries link correctly
-cmath_check_source = get_expression_value(["<cmath>"], "cos(0. * argc)")
-retcode, cmath_works = conf.TryRun(cmath_check_source, ".cpp")
-if cmath_works.strip() != "1":
-    config_error(
-        "The C++ compiler is not correctly configured (failed at linking stage)."
-    )
-
-# Check that NaN is treated correctly
-nan_check_source = get_expression_value(["<cmath>"], "std::isnan(NAN + argc)")
-retcode, nan_works = conf.TryRun(nan_check_source, ".cpp")
-if nan_works.strip() != "1":
-    config_error(
-        "Cantera requires a working implementation of 'std::isnan'.\n"
-        "If you have specified '-ffast-math' or equivalent as an optimization option,\n"
-        "either remove this option or add the '-fno-finite-math-only option'."
-    )
-
 # Check for fmt library and checkout submodule if needed
 # Test for 'ostream.h' to ensure that version >= 3.0.0 is available
 if env['system_fmt'] in ('y', 'default'):
@@ -1209,18 +1191,6 @@ if env['system_fmt'] in ('n', 'default'):
                          'Try manually checking out the submodule with:\n\n'
                          '    git submodule update --init --recursive ext/fmt\n')
 
-fmt_include = '<fmt/format.h>' if env['system_fmt'] else '"../ext/fmt/include/fmt/format.h"'
-fmt_version_source = get_expression_value([fmt_include], 'FMT_VERSION', ['FMT_HEADER_ONLY'])
-retcode, fmt_lib_version = conf.TryRun(fmt_version_source, '.cpp')
-try:
-    fmt_lib_version = divmod(float(fmt_lib_version.strip()), 10000)
-    (fmt_maj, (fmt_min, fmt_pat)) = fmt_lib_version[0], divmod(fmt_lib_version[1], 100)
-    env['FMT_VERSION'] = '{major:.0f}.{minor:.0f}.{patch:.0f}'.format(major=fmt_maj, minor=fmt_min, patch=fmt_pat)
-    logger.info(f"Found fmt version {env['FMT_VERSION']}")
-except ValueError:
-    env['FMT_VERSION'] = '0.0.0'
-    logger.info("INFO: Could not find version of fmt")
-
 # Check for yaml-cpp library and checkout submodule if needed
 if env['system_yamlcpp'] in ('y', 'default'):
     # We need the Mark() function, which was added in version 0.5.3
@@ -1316,12 +1286,6 @@ if env["system_eigen"] in ("n", "default"):
                          "    git submodule update --init --recursive ext/eigen\n")
     eigen_include = "'../ext/eigen/Eigen/Core'"
 
-eigen_versions = 'QUOTE(EIGEN_WORLD_VERSION) "." QUOTE(EIGEN_MAJOR_VERSION) "." QUOTE(EIGEN_MINOR_VERSION)'
-eigen_version_source = get_expression_value([eigen_include], eigen_versions)
-retcode, eigen_lib_version = conf.TryRun(eigen_version_source, ".cpp")
-env["EIGEN_LIB_VERSION"] = eigen_lib_version.strip()
-logger.info(f"Found Eigen version {env['EIGEN_LIB_VERSION']}")
-
 # Determine which standard library to link to when using Fortran to
 # compile code that links to Cantera
 if conf.CheckDeclaration('__GLIBCXX__', '#include <iostream>', 'C++'):
@@ -1344,18 +1308,6 @@ else:
     env["HAS_OPENMP"] = False
     logger.info("Not checking for OpenMP support due to using XCode compiler.")
 
-boost_version_source = get_expression_value(['<boost/version.hpp>'], 'BOOST_LIB_VERSION')
-retcode, boost_lib_version = conf.TryRun(boost_version_source, '.cpp')
-env['BOOST_LIB_VERSION'] = '.'.join(boost_lib_version.strip().split('_'))
-if not env['BOOST_LIB_VERSION']:
-    config_error("Boost could not be found. Install Boost headers or set"
-                 " 'boost_inc_dir' to point to the boost headers.")
-else:
-    logger.info(f"Found Boost version {env['BOOST_LIB_VERSION']}")
-if parse_version(env['BOOST_LIB_VERSION']) < parse_version("1.61"):
-    # dll support is available in Boost 1.61 or newer
-    config_error("Cantera requires Boost version 1.61 or newer.")
-
 # check BLAS/LAPACK installations
 if env["system_blas_lapack"] == "n":
     env["blas_lapack_libs"] = []
@@ -1396,32 +1348,6 @@ elif env["system_blas_lapack"] == "default":
     if not env["blas_lapack_libs"] and env["OS"] != "Darwin":
         logger.info("No system BLAS/LAPACK libraries detected.")
 
-if "mkl_rt" in env["blas_lapack_libs"]:
-    mkl_version = textwrap.dedent("""\
-        #include <iostream>
-        #include "mkl.h"
-        int main(int argc, char** argv) {
-            MKLVersion Version;
-            mkl_get_version(&Version);
-            std::cout << Version.MajorVersion << "." << Version.MinorVersion << "."
-                << Version.UpdateVersion << " for " << Version.Platform;
-            return 0;
-        }
-    """)
-    retcode, mkl_version = conf.TryRun(mkl_version, ".cpp")
-    if retcode:
-        logger.info(f"Using MKL {mkl_version}")
-    else:
-        logger.warning("Failed to determine MKL version.")
-
-elif "openblas" in env["blas_lapack_libs"]:
-    openblas_version_source = get_expression_value(["<openblas_config.h>"], "OPENBLAS_VERSION")
-    retcode, openblas_version = conf.TryRun(openblas_version_source, ".cpp")
-    if retcode:
-        logger.info(f"Using {openblas_version.strip()}")
-    else:
-        logger.warning("Failed to determine OpenBLAS version.")
-
 import SCons.Conftest, SCons.SConf
 context = SCons.SConf.CheckContext(conf)
 
@@ -1477,24 +1403,8 @@ if env['system_sundials'] == 'y':
                    'sunnonlinsol'):
         remove_directory('include/cantera/ext/' + subdir)
 
-    # Determine Sundials version
-    sundials_version_source = get_expression_value(['"sundials/sundials_config.h"'],
-                                                   'QUOTE(SUNDIALS_VERSION)')
-    retcode, sundials_version = conf.TryRun(sundials_version_source, '.cpp')
-    if retcode == 0:
-        config_error("Failed to determine Sundials version.")
-    sundials_version = sundials_version.strip(' "\n')
-
-    # Ignore the minor version, for example 2.4.x -> 2.4
-    env['sundials_version'] = '.'.join(sundials_version.split('.')[:2])
+    env['sundials_version'] = "6.6"
     sundials_ver = parse_version(env['sundials_version'])
-    if sundials_ver < parse_version("3.0") or sundials_ver >= parse_version("7.0"):
-        logger.error(f"Sundials version {env['sundials_version']!r} is not supported.")
-        sys.exit(1)
-    elif sundials_ver > parse_version("6.4.1"):
-        logger.warning(f"Sundials version {env['sundials_version']!r} has not been tested.")
-
-    logger.info(f"Using system installation of Sundials version {sundials_version!r}.")
 
     # Determine whether or not Sundials was built with BLAS/LAPACK
     if sundials_ver < parse_version('5.5'):
-- 
2.39.2 (Apple Git-143)

